<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #fcfaf7; padding: 50px; text-align: center; }
        .canvas-container { width: 400px; height: 400px; background: #eee; margin: 20px auto; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #preview-img { max-width: 100%; max-height: 100%; }
        .active { background-color: #1c1917 !important; color: white !important; }
    </style>
</head>
<body>

    <h2 class="text-xl font-bold mb-6">通义千问 Image-Edit 测试工具</h2>

    <div class="flex gap-2 justify-center mb-6">
        <button onclick="selectStyle(this, '徽州生宣')" class="style-btn active border border-stone-800 px-4 py-2 text-xs">徽州生宣</button>
        <button onclick="selectStyle(this, '贵州皮纸')" class="style-btn border border-stone-800 px-4 py-2 text-xs">贵州皮纸</button>
        <button onclick="selectStyle(this, '棠岙竹纸')" class="style-btn border border-stone-800 px-4 py-2 text-xs">棠岙竹纸</button>
        <button onclick="selectStyle(this, '西北毛边')" class="style-btn border border-stone-800 px-4 py-2 text-xs">西北毛边</button>
    </div>

    <div class="canvas-container">
        <img id="preview-img" src="" alt="请上传图片">
    </div>

    <div class="flex gap-4 justify-center">
        <input type="file" id="file-input" class="hidden" onchange="previewFile()">
        <button onclick="document.getElementById('file-input').click()" class="bg-stone-200 px-6 py-2 text-xs border border-stone-800">上传图片</button>
        <button onclick="startAiProcess()" id="gen-btn" class="bg-stone-800 text-white px-6 py-2 text-xs">开始生成</button>
    </div>

    <p id="status-text" class="mt-4 text-stone-500 text-xs"></p>

    <script>
        let selectedStyle = "徽州生宣";
        let base64Image = "";

        // 风格提示词库
        const prompts = {
            "徽州生宣": "国画大师作品，徽州生宣纸感，水墨洇散效果。",
            "贵州皮纸": "国画大师作品，贵州皮纸，厚重纤维纹理，古旧感。",
            "棠岙竹纸": "国画大师作品，棠岙竹纸，细腻竹纤维，温润色泽。",
            "西北毛边": "国画大师作品，西北毛边纸，粗糙边缘，质朴吸水感。"
        };

        // 切换风格按钮
        function selectStyle(btn, name) {
            document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStyle = name;
            console.log("当前选择风格:", selectedStyle);
        }

        // 预览上传的图片
        function previewFile() {
            const file = document.getElementById('file-input').files[0];
            const preview = document.getElementById('preview-img');
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
                base64Image = reader.result;
                console.log("图片已加载");
            }

            if (file) {
                reader.readAsDataURL(file);
            }
        }

        // 调用 API
        async function startAiProcess() {
            if (!base64Image) {
                alert("请先上传图片！");
                return;
            }

            const btn = document.getElementById('gen-btn');
            const status = document.getElementById('status-text');
            
            btn.disabled = true;
            status.innerText = `大师正在绘制【${selectedStyle}】风格...`;

            try {
                // 注意：这里的 URL 需要是你后端配置好的转发地址
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompts[selectedStyle],
                        image: base64Image
                    })
                });

                const data = await response.json();
                if (data.url) {
                    document.getElementById('preview-img').src = data.url;
                    status.innerText = "绘制完成！";
                } else {
                    status.innerText = "API 返回错误，请检查后端。";
                }
            } catch (error) {
                console.error(error);
                status.innerText = "网络请求失败。";
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>